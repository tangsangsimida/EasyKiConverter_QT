name: Build and Release Multi-Platform Binaries

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    if: contains(github.event.head_commit.message, '[release]') || github.event_name == 'pull_request'
    
    name: Build on ${{ matrix.os }} (${{ matrix.distro || matrix.arch || 'default' }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Windows builds
          - os: windows-latest
            arch: x64
            asset_name: EasyKiConverter-windows-x64.exe
            package_type: exe
          - os: windows-latest
            arch: x64
            asset_name: EasyKiConverter-windows-x64.msi
            package_type: msi
          - os: windows-latest
            arch: x86
            asset_name: EasyKiConverter-windows-x86.exe
            package_type: exe
          - os: windows-latest
            arch: x86
            asset_name: EasyKiConverter-windows-x86.msi
            package_type: msi
          
          # Linux builds for different distributions
          # Ubuntu/Debian-based distributions
          - os: ubuntu-latest
            distro: ubuntu
            arch: x64
            asset_name: EasyKiConverter-ubuntu-x64.deb
            package_type: deb
          
          # Fedora/RHEL-based distributions
          - os: ubuntu-latest
            distro: fedora
            arch: x64
            asset_name: EasyKiConverter-fedora-x64.rpm
            package_type: rpm
          
          # Arch Linux
          - os: ubuntu-latest
            distro: arch
            arch: x64
            asset_name: EasyKiConverter-arch-x64.tar.xz
            package_type: tarball
          
          # Generic Linux binary (works on most distributions)
          - os: ubuntu-latest
            distro: generic
            arch: x64
            asset_name: EasyKiConverter-linux-x64
            package_type: binary
          
          # macOS builds
          - os: macos-latest
            arch: intel
            asset_name: EasyKiConverter-macos-intel
            package_type: binary
          - os: macos-latest
            arch: apple-silicon
            asset_name: EasyKiConverter-macos-apple-silicon
            package_type: binary

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r build_conf/requirements_app.txt    
          pip install pyinstaller                       # å®‰è£… PyInstaller
          
          # Windowsç‰¹å®šä¾èµ– - å®‰è£…WiX Toolsetç”¨äºMSIæ„å»º
          if [ "${{ matrix.os }}" == "windows-latest" ] && [ "${{ matrix.package_type }}" == "msi" ]; then
            # ä¸‹è½½å¹¶å®‰è£…WiX Toolset
            curl -L -o wixtoolset.exe https://github.com/wixtoolset/wix3/releases/download/wix3112rtm/wix311.exe
            ./wixtoolset.exe /install /quiet /norestart
            echo "C:\Program Files (x86)\WiX Toolset v3.11\bin" >> $GITHUB_PATH
          fi
          
          # Linuxç‰¹å®šä¾èµ–
          if [ "${{ matrix.os }}" == "ubuntu-latest" ]; then
            sudo apt-get update
            sudo apt-get install -y rpm tar xz-utils
            # æ ¹æ®åŒ…ç±»å‹å®‰è£…ç‰¹å®šä¾èµ–
            if [ "${{ matrix.package_type }}" == "deb" ]; then
              pip install stdeb  # ç”¨äºåˆ›å»ºdebåŒ…çš„é¢å¤–ä¾èµ–
            fi
          fi
        shell: bash

      - name: Build with PyInstaller
        run: |
          # æ˜¾ç¤ºå½“å‰ç›®å½•å’Œæ–‡ä»¶ç»“æ„ä»¥è¿›è¡Œè°ƒè¯•
          echo "Current directory: $(pwd)"
          echo "Directory structure:"
          ls -la
          echo "Build conf directory:"
          ls -la build_conf/
          echo "Source directory:"
          ls -la src/ui/pyqt6/
          echo "Resources directory:"
          ls -la src/ui/pyqt6/resources/
          
          # æ ¹æ®å¹³å°å’Œæ¶æ„è®¾ç½®ç‰¹å®šå‚æ•°
          if [ "${{ matrix.os }}" == "windows-latest" ]; then
            # Windowsæ„å»º
            if [ -f "src/ui/pyqt6/resources/app_icon.ico" ]; then
              if [ "${{ matrix.arch }}" == "x86" ]; then
                # Windows x86æ„å»º
                pyinstaller build_conf/build.spec --noconfirm -i src/ui/pyqt6/resources/app_icon.ico --arch ${{ matrix.arch }}
              else
                # Windows x64æ„å»º
                pyinstaller build_conf/build.spec --noconfirm -i src/ui/pyqt6/resources/app_icon.ico
              fi
            else
              # æ²¡æœ‰æ‰¾åˆ°å›¾æ ‡æ–‡ä»¶ï¼Œä½¿ç”¨é»˜è®¤æ„å»º
              if [ "${{ matrix.arch }}" == "x86" ]; then
                pyinstaller build_conf/build.spec --noconfirm --arch ${{ matrix.arch }}
              else
                pyinstaller build_conf/build.spec --noconfirm
              fi
            fi
          elif [ "${{ matrix.os }}" == "macos-latest" ]; then
            # macOSæ„å»º
            if [ -f "src/ui/pyqt6/resources/app_icon.icns" ]; then
              pyinstaller build_conf/build.spec --noconfirm -i src/ui/pyqt6/resources/app_icon.icns
            else
              pyinstaller build_conf/build.spec --noconfirm
            fi
          else
            # Linuxæ„å»º
            pyinstaller build_conf/build.spec --noconfirm
          fi
          
          # æ˜¾ç¤ºæ„å»ºç»“æœ
          echo "Build completed. Dist directory contents:"
          if [ -d "dist" ]; then
            ls -la dist/
          else
            echo "Dist directory not found"
          fi
        shell: bash

      - name: Create MSI package (Windows)
        if: matrix.os == 'windows-latest' && matrix.package_type == 'msi'
        run: |
          # æ£€æŸ¥æ˜¯å¦æˆåŠŸæ„å»ºäº†å¯æ‰§è¡Œæ–‡ä»¶
          if [ -f "dist/EasyKiConverter.exe" ]; then
            # åˆ›å»ºMSIæ„å»ºç›®å½•
            mkdir -p msi-build
            
            # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶å’Œèµ„æº
            cp dist/EasyKiConverter.exe msi-build/
            
            # å¤åˆ¶å›¾æ ‡æ–‡ä»¶
            if [ -f "src/ui/pyqt6/resources/app_icon.ico" ]; then
              cp src/ui/pyqt6/resources/app_icon.ico msi-build/
            fi
            
            # åˆ›å»ºWiXæºæ–‡ä»¶
            cat > msi-build/product.wxs << 'EOF'
            <?xml version="1.0" encoding="UTF-8"?>
            <Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
              <Product Id="*" Name="EasyKiConverter" Language="1033" Version="1.0.0.0" 
                       Manufacturer="EasyKiConverter Team" UpgradeCode="12345678-1234-1234-1234-123456789012">
                <Package InstallerVersion="200" Compressed="yes" InstallScope="perMachine" />
                
                <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
                <MediaTemplate />
                
                <Feature Id="ProductFeature" Title="EasyKiConverter" Level="1">
                  <ComponentGroupRef Id="ProductComponents" />
                </Feature>
                
                <!-- åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼ -->
                <Icon Id="app_icon.ico" SourceFile="app_icon.ico" />
                <Property Id="ARPPRODUCTICON" Value="app_icon.ico" />
              </Product>
              
              <Fragment>
                <Directory Id="TARGETDIR" Name="SourceDir">
                  <Directory Id="ProgramFilesFolder">
                    <Directory Id="INSTALLFOLDER" Name="EasyKiConverter" />
                  </Directory>
                  <Directory Id="DesktopFolder" Name="Desktop" />
                </Directory>
              </Fragment>
              
              <Fragment>
                <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
                  <Component Id="MainExecutable" Guid="12345678-1234-1234-1234-123456789013">
                    <File Id="EasyKiConverter.exe" Source="EasyKiConverter.exe" KeyPath="yes">
                      <Shortcut Id="DesktopShortcut" Directory="DesktopFolder" Name="EasyKiConverter" 
                                WorkingDirectory="INSTALLFOLDER" Icon="app_icon.ico" />
                    </File>
                  </Component>
                  <Component Id="AppIcon" Guid="12345678-1234-1234-1234-123456789014">
                    <File Id="app_icon.ico" Source="app_icon.ico" KeyPath="yes" />
                  </Component>
                </ComponentGroup>
              </Fragment>
            </Wix>
            EOF
            
            # ä½¿ç”¨WiXå·¥å…·æ„å»ºMSI
            cd msi-build
            candle product.wxs
            light product.wixobj -out ../dist/${{ matrix.asset_name }}
            cd ..
          else
            echo "Executable not found, skipping MSI creation"
          fi
        shell: bash

      - name: Create DEB package (Ubuntu/Debian)
        if: matrix.os == 'ubuntu-latest' && matrix.distro == 'ubuntu'
        run: |
          # åˆ›å»ºDEBåŒ…ç»“æ„ï¼ˆåœ¨Ubuntuç¯å¢ƒä¸­æ„å»ºï¼Œéµå¾ªDebianæ ‡å‡†ï¼‰
          mkdir -p easykiconverter-deb/usr/bin
          mkdir -p easykiconverter-deb/usr/share/applications
          mkdir -p easykiconverter-deb/usr/share/icons/hicolor/256x256/apps
          mkdir -p easykiconverter-deb/DEBIAN
          
          # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
          cp dist/EasyKiConverter easykiconverter-deb/usr/bin/
          
          # åˆ›å»ºdesktopæ–‡ä»¶ï¼ˆéµå¾ªDebianæ ‡å‡†ï¼‰
          cat > easykiconverter-deb/usr/share/applications/easykiconverter.desktop << 'EOF'
          [Desktop Entry]
          Name=EasyKiConverter
          Comment=Convert LCSC and EasyEDA components to KiCad format
          Exec=/usr/bin/EasyKiConverter
          Icon=easykiconverter
          Terminal=false
          Type=Application
          Categories=Development;Electronics;
          # æ·»åŠ ä»»åŠ¡æ å›¾æ ‡æ”¯æŒ
          StartupNotify=true
          StartupWMClass=EasyKiConverter
          EOF
          
          # å¤åˆ¶å›¾æ ‡
          if [ -f "src/ui/pyqt6/resources/app_icon.png" ]; then
            cp src/ui/pyqt6/resources/app_icon.png easykiconverter-deb/usr/share/icons/hicolor/256x256/apps/easykiconverter.png
          fi
          
          # åˆ›å»ºcontrolæ–‡ä»¶ï¼ˆéµå¾ªDebianæ ‡å‡†ï¼‰
          cat > easykiconverter-deb/DEBIAN/control << 'EOF'
          Package: easykiconverter
          Version: 1.0.0
          Section: devel
          Priority: optional
          Architecture: amd64
          Maintainer: EasyKiConverter Team <easykiconverter@example.com>
          Description: EasyKiConverter - Convert LCSC and EasyEDA components to KiCad format
           A powerful Python tool for converting LCSC and EasyEDA components to KiCad format,
           supporting complete conversion of symbols, footprints, and 3D models.
          EOF
          
          # è®¾ç½®æƒé™ï¼ˆéµå¾ªDebianæ ‡å‡†ï¼‰
          chmod 755 easykiconverter-deb/usr/bin/EasyKiConverter
          chmod 644 easykiconverter-deb/usr/share/applications/easykiconverter.desktop
          if [ -f "easykiconverter-deb/usr/share/icons/hicolor/256x256/apps/easykiconverter.png" ]; then
            chmod 644 easykiconverter-deb/usr/share/icons/hicolor/256x256/apps/easykiconverter.png
          fi
          
          # æ„å»ºDEBåŒ…
          dpkg-deb --build easykiconverter-deb
          mv easykiconverter-deb.deb dist/${{ matrix.asset_name }}
        shell: bash

      - name: Create RPM package (Fedora/RHEL)
        if: matrix.os == 'ubuntu-latest' && matrix.distro == 'fedora'
        run: |
          # åˆ›å»ºRPMæ„å»ºç›®å½•ç»“æ„ï¼ˆåœ¨Ubuntuç¯å¢ƒä¸­æ„å»ºï¼Œéµå¾ªRPMæ ‡å‡†ï¼‰
          mkdir -p rpmbuild/{BUILD,BUILDROOT,RPMS,SOURCES,SPECS,SRPMS}
          
          # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶åˆ°SOURCESç›®å½•
          cp dist/EasyKiConverter rpmbuild/SOURCES/
          
          # å¤åˆ¶å›¾æ ‡åˆ°SOURCESç›®å½•
          if [ -f "src/ui/pyqt6/resources/app_icon.png" ]; then
            cp src/ui/pyqt6/resources/app_icon.png rpmbuild/SOURCES/easykiconverter.png
          fi
          
          # åˆ›å»ºSPECæ–‡ä»¶ï¼ˆéµå¾ªRPMæ ‡å‡†ï¼‰
          cat > rpmbuild/SPECS/easykiconverter.spec << 'EOF'
          Name: easykiconverter
          Version: 1.0.0
          Release: 1
          Summary: Convert LCSC and EasyEDA components to KiCad format
          License: GPL-3.0
          BuildArch: x86_64
          
          %description
          A powerful Python tool for converting LCSC and EasyEDA components to KiCad format,
          supporting complete conversion of symbols, footprints, and 3D models.
          
          %files
          %{_bindir}/EasyKiConverter
          %{_datadir}/icons/hicolor/256x256/apps/easykiconverter.png
          %{_datadir}/applications/easykiconverter.desktop
          
          %install
          mkdir -p %{buildroot}%{_bindir}
          mkdir -p %{buildroot}%{_datadir}/icons/hicolor/256x256/apps
          mkdir -p %{buildroot}%{_datadir}/applications
          
          cp %{_sourcedir}/EasyKiConverter %{buildroot}%{_bindir}/EasyKiConverter
          chmod 755 %{buildroot}%{_bindir}/EasyKiConverter
          
          if [ -f "%{_sourcedir}/easykiconverter.png" ]; then
            cp %{_sourcedir}/easykiconverter.png %{buildroot}%{_datadir}/icons/hicolor/256x256/apps/easykiconverter.png
            chmod 644 %{buildroot}%{_datadir}/icons/hicolor/256x256/apps/easykiconverter.png
          fi
          
          cat > %{buildroot}%{_datadir}/applications/easykiconverter.desktop << 'DESKTOP'
          [Desktop Entry]
          Name=EasyKiConverter
          Comment=Convert LCSC and EasyEDA components to KiCad format
          Exec=/usr/bin/EasyKiConverter
          Icon=easykiconverter
          Terminal=false
          Type=Application
          Categories=Development;Electronics;
          # æ·»åŠ ä»»åŠ¡æ å›¾æ ‡æ”¯æŒ
          StartupNotify=true
          StartupWMClass=EasyKiConverter
          DESKTOP
          
          chmod 644 %{buildroot}%{_datadir}/applications/easykiconverter.desktop
          
          %prep
          
          %build
          
          %clean
          rm -rf %{buildroot}
          EOF
          
          # æ„å»ºRPMåŒ…ï¼ˆä½¿ç”¨æ ‡å‡†å·¥å…·ï¼‰
          rpmbuild --define "_topdir $(pwd)/rpmbuild" -bb rpmbuild/SPECS/easykiconverter.spec
          mv rpmbuild/RPMS/x86_64/*.rpm dist/${{ matrix.asset_name }}
        shell: bash

      - name: Create tarball package (Arch Linux)
        if: matrix.os == 'ubuntu-latest' && matrix.distro == 'arch'
        run: |
          # åˆ›å»ºArch LinuxåŒ…ç»“æ„ï¼ˆåœ¨Ubuntuç¯å¢ƒä¸­æ„å»ºï¼Œä½†éµå¾ªArch Linuxæ ‡å‡†ï¼‰
          mkdir -p easykiconverter-arch/usr/bin
          mkdir -p easykiconverter-arch/usr/share/applications
          mkdir -p easykiconverter-arch/usr/share/icons/hicolor/256x256/apps
          
          # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
          cp dist/EasyKiConverter easykiconverter-arch/usr/bin/
          
          # å¤åˆ¶å›¾æ ‡
          if [ -f "src/ui/pyqt6/resources/app_icon.png" ]; then
            cp src/ui/pyqt6/resources/app_icon.png easykiconverter-arch/usr/share/icons/hicolor/256x256/apps/easykiconverter.png
          fi
          
          # åˆ›å»ºdesktopæ–‡ä»¶ï¼ˆéµå¾ªArch Linuxæ ‡å‡†ï¼‰
          cat > easykiconverter-arch/usr/share/applications/easykiconverter.desktop << 'EOF'
          [Desktop Entry]
          Name=EasyKiConverter
          Comment=Convert LCSC and EasyEDA components to KiCad format
          Exec=/usr/bin/EasyKiConverter
          Icon=easykiconverter
          Terminal=false
          Type=Application
          Categories=Development;Electronics;
          # æ·»åŠ ä»»åŠ¡æ å›¾æ ‡æ”¯æŒ
          StartupNotify=true
          StartupWMClass=EasyKiConverter
          EOF
          
          # è®¾ç½®æƒé™ï¼ˆéµå¾ªArch Linuxæ ‡å‡†ï¼‰
          chmod 755 easykiconverter-arch/usr/bin/EasyKiConverter
          chmod 644 easykiconverter-arch/usr/share/applications/easykiconverter.desktop
          if [ -f "easykiconverter-arch/usr/share/icons/hicolor/256x256/apps/easykiconverter.png" ]; then
            chmod 644 easykiconverter-arch/usr/share/icons/hicolor/256x256/apps/easykiconverter.png
          fi
          
          # åˆ›å»ºtar.xzåŒ…ï¼ˆArch Linuxæ ‡å‡†å‹ç¼©æ ¼å¼ï¼‰
          tar -cJf dist/${{ matrix.asset_name }} -C easykiconverter-arch .
        shell: bash

      - name: Create desktop files and icons for Generic Linux binary
        if: matrix.os == 'ubuntu-latest' && matrix.distro == 'generic'
        run: |
          if [ -f "dist/EasyKiConverter" ]; then
            # åˆ›å»ºç›®å½•ç»“æ„
            mkdir -p easykiconverter-linux/usr/bin
            mkdir -p easykiconverter-linux/usr/share/applications
            mkdir -p easykiconverter-linux/usr/share/icons/hicolor/256x256/apps
            
            # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
            cp dist/EasyKiConverter easykiconverter-linux/usr/bin/
            
            # å¤åˆ¶å›¾æ ‡
            if [ -f "src/ui/pyqt6/resources/app_icon.png" ]; then
              cp src/ui/pyqt6/resources/app_icon.png easykiconverter-linux/usr/share/icons/hicolor/256x256/apps/easykiconverter.png
            fi
            
            # åˆ›å»ºdesktopæ–‡ä»¶
            cat > easykiconverter-linux/usr/share/applications/easykiconverter.desktop << 'EOF'
            [Desktop Entry]
            Name=EasyKiConverter
            Comment=Convert LCSC and EasyEDA components to KiCad format
            Exec=/usr/bin/EasyKiConverter
            Icon=easykiconverter
            Terminal=false
            Type=Application
            Categories=Development;Electronics;
            # æ·»åŠ ä»»åŠ¡æ å›¾æ ‡æ”¯æŒ
            StartupNotify=true
            StartupWMClass=EasyKiConverter
            EOF
            
            # è®¾ç½®æƒé™
            chmod 755 easykiconverter-linux/usr/bin/EasyKiConverter
            chmod 644 easykiconverter-linux/usr/share/applications/easykiconverter.desktop
            if [ -f "easykiconverter-linux/usr/share/icons/hicolor/256x256/apps/easykiconverter.png" ]; then
              chmod 644 easykiconverter-linux/usr/share/icons/hicolor/256x256/apps/easykiconverter.png
            fi
            
            # åˆ›å»ºtar.gzåŒ…
            tar -czf dist/${{ matrix.asset_name }}.tar.gz -C easykiconverter-linux .
            
            # ä¹Ÿåˆ›å»ºä¸€ä¸ªä¸å¸¦ç›®å½•ç»“æ„çš„å¯æ‰§è¡Œæ–‡ä»¶
            mv dist/EasyKiConverter dist/${{ matrix.asset_name }}
          fi
        shell: bash

      - name: Create Windows package with icons
        if: matrix.os == 'windows-latest' && matrix.package_type == 'exe'
        run: |
          if [ -f "dist/EasyKiConverter.exe" ]; then
            # åˆ›å»ºWindowså®‰è£…åŒ…ç»“æ„
            mkdir -p easykiconverter-windows
            
            # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
            cp dist/EasyKiConverter.exe easykiconverter-windows/
            
            # å¤åˆ¶å›¾æ ‡æ–‡ä»¶
            if [ -f "src/ui/pyqt6/resources/app_icon.ico" ]; then
              cp src/ui/pyqt6/resources/app_icon.ico easykiconverter-windows/
            fi
            
            # åˆ›å»ºæ‰¹å¤„ç†æ–‡ä»¶ç”¨äºåˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
            cat > easykiconverter-windows/install.bat << 'EOF'
            @echo off
            echo Creating desktop shortcut...
            copy "%~dp0EasyKiConverter.exe" "%USERPROFILE%\Desktop\EasyKiConverter.exe"
            echo Shortcut created on desktop
            pause
            EOF
            
            # åˆ›å»ºZIPåŒ…
            cd easykiconverter-windows
            7z a ../dist/${{ matrix.asset_name }}.zip *
            cd ..
            
            # ä¹Ÿåˆ›å»ºä¸€ä¸ªå•ç‹¬çš„EXEæ–‡ä»¶
            mv dist/EasyKiConverter.exe dist/${{ matrix.asset_name }}
          fi
        shell: bash

      - name: Create macOS package with icons
        if: matrix.os == 'macos-latest'
        run: |
          if [ -f "dist/EasyKiConverter" ]; then
            # åˆ›å»ºmacOSåº”ç”¨åŒ…ç»“æ„
            mkdir -p EasyKiConverter.app/Contents/MacOS
            mkdir -p EasyKiConverter.app/Contents/Resources
            mkdir -p EasyKiConverter.app/Contents/Resources/AppIcon.iconset
            
            # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
            cp dist/EasyKiConverter EasyKiConverter.app/Contents/MacOS/
            
            # å¤åˆ¶å›¾æ ‡æ–‡ä»¶
            if [ -f "src/ui/pyqt6/resources/app_icon.icns" ]; then
              cp src/ui/pyqt6/resources/app_icon.icns EasyKiConverter.app/Contents/Resources/
            fi
            
            # åˆ›å»ºInfo.plistæ–‡ä»¶
            cat > EasyKiConverter.app/Contents/Info.plist << 'EOF'
            <?xml version="1.0" encoding="UTF-8"?>
            <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
            <plist version="1.0">
            <dict>
                <key>CFBundleExecutable</key>
                <string>EasyKiConverter</string>
                <key>CFBundleIconFile</key>
                <string>app_icon.icns</string>
                <key>CFBundleIdentifier</key>
                <string>com.easykiconverter.app</string>
                <key>CFBundleName</key>
                <string>EasyKiConverter</string>
                <key>CFBundlePackageType</key>
                <string>APPL</string>
                <key>CFBundleShortVersionString</key>
                <string>1.0.0</string>
                <key>CFBundleVersion</key>
                <string>1.0.0</string>
                <key>LSMinimumSystemVersion</key>
                <string>10.12</string>
                <key>NSHumanReadableCopyright</key>
                <string>Copyright Â© 2025 EasyKiConverter Team</string>
            </dict>
            </plist>
            EOF
            
            # åˆ›å»ºZIPåŒ…
            zip -r dist/${{ matrix.asset_name }}.zip EasyKiConverter.app
            
            # ä¹Ÿåˆ›å»ºä¸€ä¸ªå•ç‹¬çš„å¯æ‰§è¡Œæ–‡ä»¶
            mv dist/EasyKiConverter dist/${{ matrix.asset_name }}
          fi
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset_name }}
          path: dist/${{ matrix.asset_name }}

  release:
    needs: build
    if: always() && needs.build.result == 'success' && contains(github.event.head_commit.message, '[release]')
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets

      - name: Generate version tag
        run: |
          VERSION="EasyKiConverter_QT-$(date +%Y%m%d)"
          echo "RELEASE_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_VERSION }}
          name: ${{ env.RELEASE_VERSION }}
          body: |
            ## ğŸ“¦ ä¸‹è½½
            
            ### Windows
            - x64: `EasyKiConverter-windows-x64.exe` (å•ç‹¬å¯æ‰§è¡Œæ–‡ä»¶)
            - x64: `EasyKiConverter-windows-x64.exe.zip` (åŒ…å«å›¾æ ‡å’Œå®‰è£…è„šæœ¬çš„ZIPåŒ…)
            - x64: `EasyKiConverter-windows-x64.msi` (MSIå®‰è£…åŒ…ï¼ŒåŒ…å«å®Œæ•´æ¡Œé¢é›†æˆ)
            - x86: `EasyKiConverter-windows-x86.exe` (å•ç‹¬å¯æ‰§è¡Œæ–‡ä»¶)
            - x86: `EasyKiConverter-windows-x86.exe.zip` (åŒ…å«å›¾æ ‡å’Œå®‰è£…è„šæœ¬çš„ZIPåŒ…)
            - x86: `EasyKiConverter-windows-x86.msi` (MSIå®‰è£…åŒ…ï¼ŒåŒ…å«å®Œæ•´æ¡Œé¢é›†æˆ)
            
            ### Linuxå‘è¡Œç‰ˆç‰¹å®šåŒ…
            #### Ubuntu/Debian
            - DEB Package: `EasyKiConverter-ubuntu-x64.deb` (å®Œæ•´DEBåŒ…ï¼ŒåŒ…å«æ¡Œé¢å›¾æ ‡å’Œä»»åŠ¡æ æ”¯æŒ)
            
            #### Fedora/RHEL
            - RPM Package: `EasyKiConverter-fedora-x64.rpm` (å®Œæ•´RPMåŒ…ï¼ŒåŒ…å«æ¡Œé¢å›¾æ ‡å’Œä»»åŠ¡æ æ”¯æŒ)
            
            #### Arch Linux
            - Tarball Package: `EasyKiConverter-arch-x64.tar.xz` (å®Œæ•´tar.xzåŒ…ï¼ŒåŒ…å«æ¡Œé¢å›¾æ ‡å’Œä»»åŠ¡æ æ”¯æŒ)
            
            #### é€šç”¨LinuxäºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆé€‚ç”¨äºå¤§å¤šæ•°Linuxå‘è¡Œç‰ˆï¼‰
            - Binary: `EasyKiConverter-linux-x64` (å•ç‹¬å¯æ‰§è¡Œæ–‡ä»¶)
            - Binary Package: `EasyKiConverter-linux-x64.tar.gz` (åŒ…å«æ¡Œé¢å›¾æ ‡å’Œä»»åŠ¡æ æ”¯æŒçš„å®Œæ•´åŒ…)
            
            ### macOS
            - Intel: `EasyKiConverter-macos-intel` (å•ç‹¬å¯æ‰§è¡Œæ–‡ä»¶)
            - Intel: `EasyKiConverter-macos-intel.zip` (å®Œæ•´åº”ç”¨åŒ…ï¼ŒåŒ…å«å›¾æ ‡å’ŒInfo.plist)
            - Apple Silicon: `EasyKiConverter-macos-apple-silicon` (å•ç‹¬å¯æ‰§è¡Œæ–‡ä»¶)
            - Apple Silicon: `EasyKiConverter-macos-apple-silicon.zip` (å®Œæ•´åº”ç”¨åŒ…ï¼ŒåŒ…å«å›¾æ ‡å’ŒInfo.plist)

            > ğŸ’¡ **macOS ç”¨æˆ·æ³¨æ„**ï¼šé¦–æ¬¡è¿è¡Œæ—¶è‹¥æç¤º"æ— æ³•éªŒè¯å¼€å‘è€…"ï¼Œè¯·å³é”®ç‚¹å‡»æ–‡ä»¶ â†’ "Open" å³å¯è¿è¡Œã€‚æ¨èä½¿ç”¨ZIPåŒ…ä»¥è·å¾—å®Œæ•´çš„åº”ç”¨ä½“éªŒã€‚
            > ğŸ’¡ **Ubuntu/Debian ç”¨æˆ·**ï¼šæ¨èä½¿ç”¨DEBåŒ…ï¼Œå¯ç›´æ¥å®‰è£…å’Œç®¡ç†ï¼ŒåŒ…å«å®Œæ•´çš„æ¡Œé¢é›†æˆã€‚
            > ğŸ’¡ **Fedora/RHEL ç”¨æˆ·**ï¼šæ¨èä½¿ç”¨RPMåŒ…ï¼Œå¯ç›´æ¥å®‰è£…å’Œç®¡ç†ï¼ŒåŒ…å«å®Œæ•´çš„æ¡Œé¢é›†æˆã€‚
            > ğŸ’¡ **Arch Linux ç”¨æˆ·**ï¼šæ¨èä½¿ç”¨tar.xzåŒ…ï¼Œè§£å‹åå¯ç›´æ¥ä½¿ç”¨ï¼ŒåŒ…å«å®Œæ•´çš„æ¡Œé¢é›†æˆã€‚
            > ğŸ’¡ **å…¶ä»–Linuxå‘è¡Œç‰ˆç”¨æˆ·**ï¼šæ¨èä½¿ç”¨tar.gzåŒ…ä»¥è·å¾—å®Œæ•´çš„æ¡Œé¢é›†æˆä½“éªŒï¼Œæˆ–ä½¿ç”¨å•ç‹¬çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚
            > ğŸ’¡ **Windows ç”¨æˆ·**ï¼šæ¨èä½¿ç”¨MSIå®‰è£…åŒ…ä»¥è·å¾—å®Œæ•´çš„æ¡Œé¢é›†æˆä½“éªŒï¼ˆåŒ…æ‹¬å¼€å§‹èœå•é¡¹ã€æ¡Œé¢å›¾æ ‡å’Œç¨‹åºå¸è½½æ”¯æŒï¼‰ï¼Œæˆ–ä½¿ç”¨ZIPåŒ…ä»¥è·å¾—å›¾æ ‡å’Œå®‰è£…è„šæœ¬ï¼Œä¹Ÿå¯ä½¿ç”¨å•ç‹¬çš„EXEæ–‡ä»¶ã€‚
          draft: false
          prerelease: false
          files: |
            release-assets/*/*
            dist/*.tar.gz
            dist/*.zip
            dist/*.msi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}