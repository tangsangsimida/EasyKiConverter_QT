name: Build and Release Multi-Platform Binaries

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    if: contains(github.event.head_commit.message, '[release]') || github.event_name == 'pull_request'
    
    name: Build on ${{ matrix.os }} (${{ matrix.distro || matrix.arch || 'default' }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Windows builds
          - os: windows-latest
            arch: x64
            asset_name: EasyKiConverter-windows-x64.exe
            package_type: exe
          - os: windows-latest
            arch: x86
            asset_name: EasyKiConverter-windows-x86.exe
            package_type: exe
          
          # Linux builds for different distributions
          # Ubuntu/Debian-based distributions
          - os: ubuntu-latest
            distro: ubuntu
            arch: x64
            asset_name: EasyKiConverter-ubuntu-x64.deb
            package_type: deb
          
          # Fedora/RHEL-based distributions
          - os: ubuntu-latest
            distro: fedora
            arch: x64
            asset_name: EasyKiConverter-fedora-x64.rpm
            package_type: rpm
          
          # Arch Linux
          - os: ubuntu-latest
            distro: arch
            arch: x64
            asset_name: EasyKiConverter-arch-x64.tar.xz
            package_type: tarball
          
          # Generic Linux binary (works on most distributions)
          - os: ubuntu-latest
            distro: generic
            arch: x64
            asset_name: EasyKiConverter-linux-x64
            package_type: binary
          
          # macOS builds
          - os: macos-latest
            arch: intel
            asset_name: EasyKiConverter-macos-intel
            package_type: binary
          - os: macos-latest
            arch: apple-silicon
            asset_name: EasyKiConverter-macos-apple-silicon
            package_type: binary

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r build_conf/requirements_app.txt    
          pip install pyinstaller                       # å®‰è£… PyInstaller
          
          # Linuxç‰¹å®šä¾èµ–
          if [ "${{ matrix.os }}" == "ubuntu-latest" ]; then
            sudo apt-get update
            sudo apt-get install -y rpm tar xz-utils
            # æ ¹æ®åŒ…ç±»å‹å®‰è£…ç‰¹å®šä¾èµ–
            if [ "${{ matrix.package_type }}" == "deb" ]; then
              pip install stdeb  # ç”¨äºåˆ›å»ºdebåŒ…çš„é¢å¤–ä¾èµ–
            fi
          fi
        shell: bash

      - name: Build with PyInstaller
        run: |
          # æ˜¾ç¤ºå½“å‰ç›®å½•å’Œæ–‡ä»¶ç»“æ„ä»¥è¿›è¡Œè°ƒè¯•
          echo "Current directory: $(pwd)"
          echo "Directory structure:"
          ls -la
          echo "Build conf directory:"
          ls -la build_conf/
          echo "Source directory:"
          ls -la src/ui/pyqt6/
          echo "Resources directory:"
          ls -la src/ui/pyqt6/resources/
          
          # æ ¹æ®å¹³å°å’Œæ¶æ„è®¾ç½®ç‰¹å®šå‚æ•°
          if [ "${{ matrix.os }}" == "windows-latest" ] && [ "${{ matrix.arch }}" == "x86" ]; then
            # Windows x86æ„å»º
            pyinstaller build_conf/build.spec --noconfirm -- ${{ matrix.arch }}
          elif [ "${{ matrix.os }}" == "macos-latest" ]; then
            # macOSæ„å»º
            pyinstaller build_conf/build.spec --noconfirm
          else
            # é»˜è®¤æ„å»ºï¼ˆLinuxï¼‰
            pyinstaller build_conf/build.spec --noconfirm
          fi
          
          # æ˜¾ç¤ºæ„å»ºç»“æœ
          echo "Build completed. Dist directory contents:"
          if [ -d "dist" ]; then
            ls -la dist/
          else
            echo "Dist directory not found"
          fi
        shell: bash

      - name: Create DEB package (Ubuntu/Debian)
        if: matrix.os == 'ubuntu-latest' && matrix.distro == 'ubuntu'
        run: |
          # åˆ›å»ºDEBåŒ…ç»“æ„ï¼ˆåœ¨Ubuntuç¯å¢ƒä¸­æ„å»ºï¼Œéµå¾ªDebianæ ‡å‡†ï¼‰
          mkdir -p easykiconverter-deb/usr/bin
          mkdir -p easykiconverter-deb/usr/share/applications
          mkdir -p easykiconverter-deb/usr/share/icons/hicolor/256x256/apps
          mkdir -p easykiconverter-deb/DEBIAN
          
          # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
          cp dist/EasyKiConverter easykiconverter-deb/usr/bin/
          
          # åˆ›å»ºdesktopæ–‡ä»¶ï¼ˆéµå¾ªDebianæ ‡å‡†ï¼‰
          cat > easykiconverter-deb/usr/share/applications/easykiconverter.desktop << EOF
          [Desktop Entry]
          Name=EasyKiConverter
          Comment=Convert LCSC and EasyEDA components to KiCad format
          Exec=/usr/bin/EasyKiConverter
          Icon=easykiconverter
          Terminal=false
          Type=Application
          Categories=Development;Electronics;
          # æ·»åŠ ä»»åŠ¡æ å›¾æ ‡æ”¯æŒ
          StartupNotify=true
          StartupWMClass=EasyKiConverter
          EOF
          
          # å¤åˆ¶å›¾æ ‡
          if [ -f "src/ui/pyqt6/resources/app_icon.png" ]; then
            cp src/ui/pyqt6/resources/app_icon.png easykiconverter-deb/usr/share/icons/hicolor/256x256/apps/easykiconverter.png
          fi
          
          # åˆ›å»ºcontrolæ–‡ä»¶ï¼ˆéµå¾ªDebianæ ‡å‡†ï¼‰
          cat > easykiconverter-deb/DEBIAN/control << EOF
          Package: easykiconverter
          Version: 1.0.0
          Section: devel
          Priority: optional
          Architecture: amd64
          Maintainer: EasyKiConverter Team <easykiconverter@example.com>
          Description: EasyKiConverter - Convert LCSC and EasyEDA components to KiCad format
           A powerful Python tool for converting LCSC and EasyEDA components to KiCad format,
           supporting complete conversion of symbols, footprints, and 3D models.
          EOF
          
          # è®¾ç½®æƒé™ï¼ˆéµå¾ªDebianæ ‡å‡†ï¼‰
          chmod 755 easykiconverter-deb/usr/bin/EasyKiConverter
          chmod 644 easykiconverter-deb/usr/share/applications/easykiconverter.desktop
          if [ -f "easykiconverter-deb/usr/share/icons/hicolor/256x256/apps/easykiconverter.png" ]; then
            chmod 644 easykiconverter-deb/usr/share/icons/hicolor/256x256/apps/easykiconverter.png
          fi
          
          # æ„å»ºDEBåŒ…
          dpkg-deb --build easykiconverter-deb
          mv easykiconverter-deb.deb dist/${{ matrix.asset_name }}
        shell: bash

      - name: Create RPM package (Fedora/RHEL)
        if: matrix.os == 'ubuntu-latest' && matrix.distro == 'fedora'
        run: |
          # åˆ›å»ºRPMæ„å»ºç›®å½•ç»“æ„ï¼ˆåœ¨Ubuntuç¯å¢ƒä¸­æ„å»ºï¼Œéµå¾ªRPMæ ‡å‡†ï¼‰
          mkdir -p rpmbuild/{BUILD,BUILDROOT,RPMS,SOURCES,SPECS,SRPMS}
          
          # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶åˆ°SOURCESç›®å½•
          cp dist/EasyKiConverter rpmbuild/SOURCES/
          
          # å¤åˆ¶å›¾æ ‡åˆ°SOURCESç›®å½•
          if [ -f "src/ui/pyqt6/resources/app_icon.png" ]; then
            cp src/ui/pyqt6/resources/app_icon.png rpmbuild/SOURCES/easykiconverter.png
          fi
          
          # åˆ›å»ºSPECæ–‡ä»¶ï¼ˆéµå¾ªRPMæ ‡å‡†ï¼‰
          cat > rpmbuild/SPECS/easykiconverter.spec << EOF
          Name: easykiconverter
          Version: 1.0.0
          Release: 1
          Summary: Convert LCSC and EasyEDA components to KiCad format
          License: GPL-3.0
          BuildArch: x86_64
          
          %description
          A powerful Python tool for converting LCSC and EasyEDA components to KiCad format,
          supporting complete conversion of symbols, footprints, and 3D models.
          
          %files
          /usr/bin/EasyKiConverter
          /usr/share/icons/hicolor/256x256/apps/easykiconverter.png
          /usr/share/applications/easykiconverter.desktop
          
          %install
          mkdir -p $RPM_BUILD_ROOT/usr/bin
          mkdir -p $RPM_BUILD_ROOT/usr/share/icons/hicolor/256x256/apps
          mkdir -p $RPM_BUILD_ROOT/usr/share/applications
          
          cp %{_sourcedir}/EasyKiConverter $RPM_BUILD_ROOT/usr/bin/EasyKiConverter
          chmod 755 $RPM_BUILD_ROOT/usr/bin/EasyKiConverter
          
          if [ -f "%{_sourcedir}/easykiconverter.png" ]; then
            cp %{_sourcedir}/easykiconverter.png $RPM_BUILD_ROOT/usr/share/icons/hicolor/256x256/apps/easykiconverter.png
            chmod 644 $RPM_BUILD_ROOT/usr/share/icons/hicolor/256x256/apps/easykiconverter.png
          fi
          
          cat > $RPM_BUILD_ROOT/usr/share/applications/easykiconverter.desktop << 'DESKTOP'
          [Desktop Entry]
          Name=EasyKiConverter
          Comment=Convert LCSC and EasyEDA components to KiCad format
          Exec=/usr/bin/EasyKiConverter
          Icon=easykiconverter
          Terminal=false
          Type=Application
          Categories=Development;Electronics;
          # æ·»åŠ ä»»åŠ¡æ å›¾æ ‡æ”¯æŒ
          StartupNotify=true
          StartupWMClass=EasyKiConverter
          DESKTOP
          
          chmod 644 $RPM_BUILD_ROOT/usr/share/applications/easykiconverter.desktop
          
          %prep
          
          %build
          
          %clean
          rm -rf %{buildroot}
          EOF
          
          # æ„å»ºRPMåŒ…ï¼ˆä½¿ç”¨æ ‡å‡†å·¥å…·ï¼‰
          rpmbuild --define "_topdir $(pwd)/rpmbuild" -bb rpmbuild/SPECS/easykiconverter.spec
          mv rpmbuild/RPMS/x86_64/*.rpm dist/${{ matrix.asset_name }}
        shell: bash

      - name: Create tarball package (Arch Linux)
        if: matrix.os == 'ubuntu-latest' && matrix.distro == 'arch'
        run: |
          # åˆ›å»ºArch LinuxåŒ…ç»“æ„ï¼ˆåœ¨Ubuntuç¯å¢ƒä¸­æ„å»ºï¼Œä½†éµå¾ªArch Linuxæ ‡å‡†ï¼‰
          mkdir -p easykiconverter-arch/usr/bin
          mkdir -p easykiconverter-arch/usr/share/applications
          mkdir -p easykiconverter-arch/usr/share/icons/hicolor/256x256/apps
          
          # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
          cp dist/EasyKiConverter easykiconverter-arch/usr/bin/
          
          # å¤åˆ¶å›¾æ ‡
          if [ -f "src/ui/pyqt6/resources/app_icon.png" ]; then
            cp src/ui/pyqt6/resources/app_icon.png easykiconverter-arch/usr/share/icons/hicolor/256x256/apps/easykiconverter.png
          fi
          
          # åˆ›å»ºdesktopæ–‡ä»¶ï¼ˆéµå¾ªArch Linuxæ ‡å‡†ï¼‰
          cat > easykiconverter-arch/usr/share/applications/easykiconverter.desktop << EOF
          [Desktop Entry]
          Name=EasyKiConverter
          Comment=Convert LCSC and EasyEDA components to KiCad format
          Exec=/usr/bin/EasyKiConverter
          Icon=easykiconverter
          Terminal=false
          Type=Application
          Categories=Development;Electronics;
          # æ·»åŠ ä»»åŠ¡æ å›¾æ ‡æ”¯æŒ
          StartupNotify=true
          StartupWMClass=EasyKiConverter
          EOF
          
          # è®¾ç½®æƒé™ï¼ˆéµå¾ªArch Linuxæ ‡å‡†ï¼‰
          chmod 755 easykiconverter-arch/usr/bin/EasyKiConverter
          chmod 644 easykiconverter-arch/usr/share/applications/easykiconverter.desktop
          if [ -f "easykiconverter-arch/usr/share/icons/hicolor/256x256/apps/easykiconverter.png" ]; then
            chmod 644 easykiconverter-arch/usr/share/icons/hicolor/256x256/apps/easykiconverter.png
          fi
          
          # åˆ›å»ºtar.xzåŒ…ï¼ˆArch Linuxæ ‡å‡†å‹ç¼©æ ¼å¼ï¼‰
          tar -cJf dist/${{ matrix.asset_name }} -C easykiconverter-arch .
        shell: bash

      - name: Rename executable (Generic Linux binary)
        if: matrix.os == 'ubuntu-latest' && matrix.distro == 'generic'
        run: |
          if [ -f "dist/EasyKiConverter" ]; then
            mv dist/EasyKiConverter dist/${{ matrix.asset_name }}
          fi
        shell: bash

      - name: Rename Windows executable
        if: matrix.os == 'windows-latest'
        run: |
          if [ -f "dist/EasyKiConverter.exe" ]; then
            mv dist/EasyKiConverter.exe dist/${{ matrix.asset_name }}
          fi
        shell: bash

      - name: Rename macOS executable
        if: matrix.os == 'macos-latest'
        run: |
          if [ -f "dist/EasyKiConverter" ]; then
            mv dist/EasyKiConverter dist/${{ matrix.asset_name }}
          fi
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset_name }}
          path: dist/${{ matrix.asset_name }}

  release:
    needs: build
    if: always() && needs.build.result == 'success' && contains(github.event.head_commit.message, '[release]')
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets

      - name: Generate version tag
        run: |
          VERSION="EasyKiConverter_QT-$(date +%Y%m%d)"
          echo "RELEASE_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_VERSION }}
          name: ${{ env.RELEASE_VERSION }}
          body: |
            ## ğŸ“¦ ä¸‹è½½
            
            ### Windows
            - x64: `EasyKiConverter-windows-x64.exe`
            - x86: `EasyKiConverter-windows-x86.exe`
            
            ### Linuxå‘è¡Œç‰ˆç‰¹å®šåŒ…
            #### Ubuntu/Debian
            - DEB Package: `EasyKiConverter-ubuntu-x64.deb`
            
            #### Fedora/RHEL
            - RPM Package: `EasyKiConverter-fedora-x64.rpm`
            
            #### Arch Linux
            - Tarball Package: `EasyKiConverter-arch-x64.tar.xz`
            
            #### é€šç”¨LinuxäºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆé€‚ç”¨äºå¤§å¤šæ•°Linuxå‘è¡Œç‰ˆï¼‰
            - Binary: `EasyKiConverter-linux-x64`
            
            ### macOS
            - Intel: `EasyKiConverter-macos-intel`
            - Apple Silicon: `EasyKiConverter-macos-apple-silicon`

            > ğŸ’¡ **macOS ç”¨æˆ·æ³¨æ„**ï¼šé¦–æ¬¡è¿è¡Œæ—¶è‹¥æç¤º"æ— æ³•éªŒè¯å¼€å‘è€…"ï¼Œè¯·å³é”®ç‚¹å‡»æ–‡ä»¶ â†’ "Open" å³å¯è¿è¡Œã€‚
            > ğŸ’¡ **Ubuntu/Debian ç”¨æˆ·**ï¼šæ¨èä½¿ç”¨DEBåŒ…ï¼Œå¯ç›´æ¥å®‰è£…å’Œç®¡ç†ã€‚
            > ğŸ’¡ **Fedora/RHEL ç”¨æˆ·**ï¼šæ¨èä½¿ç”¨RPMåŒ…ï¼Œå¯ç›´æ¥å®‰è£…å’Œç®¡ç†ã€‚
            > ğŸ’¡ **Arch Linux ç”¨æˆ·**ï¼šæ¨èä½¿ç”¨tar.xzåŒ…ï¼Œè§£å‹åå¯ç›´æ¥ä½¿ç”¨ã€‚
            > ğŸ’¡ **å…¶ä»–Linuxå‘è¡Œç‰ˆç”¨æˆ·**ï¼šå¯ä½¿ç”¨é€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œåœ¨å¤§å¤šæ•°Linuxå‘è¡Œç‰ˆä¸Šè¿è¡Œã€‚
          draft: false
          prerelease: false
          files: |
            release-assets/*/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 
