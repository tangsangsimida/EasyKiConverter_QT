# 3D模型偏移参数计算说明

  

## 问题描述

  

在转换EasyEDA/LCSC元器件到KiCad格式时，部分元器件的3D封装会出现位置偏移异常的问题：

- 偏移位置是一个很大的值（如999999mm）

- 偏移位置错误，需要在KiCad中手动归零才能正常显示

  

## 问题根本原因

  

**核心发现**：KiCad中3D模型有三种参数：

1. **比例（Scale）**：缩放比例

2. **旋转（Rotation）**：旋转角度

3. **偏移（Offset/Translation）**：位置偏移

  

**关键点**：3D模型文件（.wrl/.step）本身已经包含了正确的位置信息，因此**偏移参数应该始终为0**。

  

当3D模型在KiCad中显示异常时，通常是因为偏移参数不为0，用户只需手动将偏移参数调整为0即可正常显示。

  

## 解决方案

  

### 修复前的问题

  

原来的代码尝试计算3D模型相对于封装的偏移量：

```python

# ❌ 错误的做法：计算偏移

translation_x = model_3d.translation.x - bbox.x

translation_y = model_3d.translation.y - bbox.y

translation_z = model_3d.translation.z

```

  

这种方法存在问题：

1. EasyEDA的3D模型位置数据可能不准确或异常

2. 计算出的偏移值可能非常大（如999999mm）

3. 用户需要在KiCad中手动将偏移调整为0

  

### 修复后的解决方案

  

**最佳实践**：直接将偏移参数设置为0

  

```python

# ✅ 正确的做法：偏移参数固定为0

ki_3d_model_info = Ki3dModel(

    name=model_3d.name,

    translation=Ki3dModelBase(

        x=0.0,  # 偏移参数固定为0

        y=0.0,  # 偏移参数固定为0

        z=0.0,  # 偏移参数固定为0

    ),

    rotation=Ki3dModelBase(

        x=(360 - model_3d.rotation.x) % 360,

        y=(360 - model_3d.rotation.y) % 360,

        z=(360 - model_3d.rotation.z) % 360,

    ),

)

```

  

### 为什么偏移应该为0？

  

1. **3D模型文件已包含位置信息**：.wrl和.step文件内部已经定义了模型的顶点坐标

2. **封装参考点对齐**：3D模型在创建时已经相对于封装的参考点（通常是中心）正确对齐

3. **避免重复偏移**：如果再添加偏移参数，会导致位置错误

  

### 旋转参数处理

  

旋转参数也需要进行坐标系转换：

  

```python

rotation_x = (360 - model_3d.rotation.x) % 360

rotation_y = (360 - model_3d.rotation.y) % 360

rotation_z = (360 - model_3d.rotation.z) % 360

```

  

## 技术细节

  

### KiCad 3D模型参数说明

  

在KiCad的封装文件（.kicad_mod）中，3D模型的定义格式如下：

  

```

(model "path/to/model.wrl"

  (offset (xyz 0 0 0))      # 偏移参数（应为0）

  (scale (xyz 1 1 1))       # 缩放比例

  (rotate (xyz 0 0 0))      # 旋转角度

)

```

  

**重要**：

- `offset`（偏移）：应始终为 (0, 0, 0)

- `scale`（比例）：通常为 (1, 1, 1)

- `rotate`（旋转）：根据需要设置

  

## 代码位置

  

相关代码位于：

- `src/core/kicad/export_kicad_footprint.py` - 第215-235行（3D模型参数设置）

- `src/core/easyeda/parameters_easyeda.py` - Ee3dModel类定义

  

## 修复效果

  

修复后的效果：

1. ✅ **所有3D模型的偏移参数统一设置为0**

2. ✅ **无需手动调整**：用户不再需要在KiCad中手动归零偏移参数

3. ✅ **简化逻辑**：移除了复杂的偏移计算和边界检查

4. ✅ **保留旋转**：旋转参数正常转换，确保3D模型方向正确

  

## 使用建议

  

1. **查看日志**：转换时注意查看日志输出，如果出现警告信息说明该元器件的3D模型位置被自动修正

  

2. **手动验证**：对于重要元器件，建议在KiCad中打开封装验证3D模型位置是否正确

  

3. **反馈问题**：如果发现某个元器件的3D模型位置始终不正确，请记录元器件编号并反馈

  

4. **调整阈值**：如果1000mm的阈值不合适，可以修改`MAX_REASONABLE_OFFSET`常量

  

## 修复前后对比

  

### 修复前（计算偏移）❌

```python

# 尝试计算相对偏移

translation_x = model_3d.translation.x - bbox.x

translation_y = model_3d.translation.y - bbox.y

translation_z = model_3d.translation.z

  

# 可能导致的问题：

# - 计算出异常大的偏移值（如999999mm）

# - 用户需要在KiCad中手动归零

# - 逻辑复杂，容易出错

```

  

**KiCad中的表现**：

```

(model "model.wrl"

  (offset (xyz 999994.0 -888878.0 -777777.0))  # ❌ 异常偏移

  (rotate (xyz 0 0 0))

)

```

  

### 修复后（固定为0）✅

```python

# 直接设置为0，简单可靠

translation=Ki3dModelBase(

    x=0.0,  # 固定为0

    y=0.0,  # 固定为0

    z=0.0,  # 固定为0

)

```

  

**KiCad中的表现**：

```

(model "model.wrl"

  (offset (xyz 0 0 0))  # ✅ 正确的偏移值

  (rotate (xyz 0 0 0))

)

```

  

### 用户体验对比

  

| 场景 | 修复前 | 修复后 |

|------|--------|--------|

| 正常元器件 | 可能有小偏移 | 完美对齐 ✅ |

| 异常元器件 | 需手动归零 ❌ | 自动正确 ✅ |

| 操作步骤 | 转换→打开KiCad→调整偏移 | 转换→完成 ✅ |

  

## 为什么这样做是正确的？

  

### 3D模型文件的本质

  

3D模型文件（.wrl和.step）包含的是**相对于封装原点的顶点坐标**：

  

```wrl

# 3D模型文件内容示例

Shape {

  geometry IndexedFaceSet {

    coord DEF co Coordinate {

      point [

        0.5 0.3 0.0,    # 顶点已经是相对坐标

        -0.5 0.3 0.0,   # 相对于封装中心

        ...

      ]

    }

  }

}

```

  

### 封装和3D模型的关系

  

```

封装文件 (.kicad_mod)

├── 焊盘位置（相对于封装原点）

├── 丝印层图形（相对于封装原点）

└── 3D模型引用

    ├── offset: (0, 0, 0)  ← 不需要额外偏移

    ├── scale: (1, 1, 1)

    └── rotate: (角度)

```

  

**关键点**：3D模型在创建时已经对齐到封装原点，所以不需要额外的偏移参数。

  

## 相关资源

  

- [KiCad文件格式文档](https://dev-docs.kicad.org/en/file-formats/)

- [EasyEDA API文档](https://easyeda.com/page/api)

- [项目问题追踪](https://github.com/tangsangsimida/EasyKiConverter_QT/issues)

  

---

  

**最后更新**：2025-12-17  

**版本**：1.0.0